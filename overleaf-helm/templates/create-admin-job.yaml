{{- if .Values.admin.create }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "overleaf-helm.fullname" . }}-create-admin-{{ randAlphaNum 5 | lower }}
  labels:
    {{- include "overleaf-helm.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
    "helm.sh/hook": post-install
spec:
  template:
    spec:
      serviceAccountName: {{ include "overleaf-helm.fullname" . }}-admin
      restartPolicy: OnFailure
      containers:
        - name: create-admin
          image: {{ .Values.admin.job.image }}
          command:
            - sh
            - -c
            - |
              echo "Waiting for sharelatex pod to be Ready..."
              POD=""
              for i in $(seq 1 30); do
                POD=$(kubectl get pods -l app=sharelatex -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
                if [ -n "$POD" ]; then
                  STATUS=$(kubectl get pod "$POD" -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}')
                  if [ "$STATUS" = "True" ]; then
                    echo "Pod $POD is Ready"
                    break
                  fi
                fi
                echo "Pod not ready yet, retrying..."
                sleep 2
              done

              if [ -z "$POD" ]; then
                echo "Error: could not find a ready sharelatex pod"
                exit 1
              fi

              echo "Running create-user.js in pod $POD..."

              kubectl exec "$POD" --container sharelatex -- \
                sh -c 'cd /overleaf/services/web && \
                  OVERLEAF_MONGO_URL="$OVERLEAF_MONGO_URL" \
                  OVERLEAF_REDIS_HOST="$OVERLEAF_REDIS_HOST" \
                  node /overleaf/services/web/modules/server-ce-scripts/scripts/create-user.js \
                  --email "$OVERLEAF_ADMIN_EMAIL" --admin' | grep -A100 -i "Successfully created"
          env:
            - name: OVERLEAF_MONGO_URL
              value: {{ .Values.sharelatex.mongoUrl | quote }}
            - name: OVERLEAF_REDIS_HOST
              value: {{ .Values.sharelatex.redisHost | quote }}
            {{- if .Values.admin.useSecret }}
            - name: OVERLEAF_ADMIN_EMAIL
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.admin.secret.name }}
                  key: {{ .Values.admin.secret.emailKey }}
            {{- else }}
            - name: OVERLEAF_ADMIN_EMAIL
              value: {{ .Values.admin.email | quote }}
            {{- end }}
{{- end }}